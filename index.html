<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yƒ±llƒ±k √áalƒ±≈üma Saati Hesaplayƒ±cƒ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338ca;
            --bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --success: #10B981;
            --danger: #EF4444;
            --neutral: #3B82F6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1000px;
        }

        h1,
        h2 {
            color: var(--primary);
            margin-top: 0;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .settings-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        input,
        select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            font-family: inherit;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 0.5rem;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button.secondary {
            background-color: white;
            border: 1px solid var(--border);
            color: var(--text);
        }

        button.secondary:hover {
            background-color: var(--bg);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--text-light);
            background-color: #F9FAFB;
        }

        .summary-row {
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .summary-row:hover {
            background-color: #EEF2FF;
        }

        .summary-row.active {
            background-color: #E0E7FF;
            font-weight: 600;
        }

        .positive {
            color: var(--success);
            font-weight: 600;
        }

        .negative {
            color: var(--danger);
            font-weight: 600;
        }

        .neutral {
            color: var(--neutral);
        }

        .day-row.weekend {
            background-color: #FEF2F2;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }

        .tab.active {
            background-color: var(--primary);
            color: white;
        }

        /* New styles for locked/disabled months */
        .locked {
            opacity: 0.5;
            color: #9CA3AF;
        }

        .locked input,
        .locked select,
        .locked button {
            pointer-events: none;
            opacity: 0.6;
        }

        .summary-row.locked {
            cursor: default;
            background-color: #F8FAFC;
        }

        .month-locked-banner {
            background: #fff7ed;
            border: 1px solid #ffedd5;
            color: #92400e;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Yƒ±llƒ±k √áalƒ±≈üma Takibi</h1>

        <div class="grid-layout">
            <!-- Left Column: Summary & Navigation -->
            <div>
                <div class="card">
                    <h2>Ayarlar</h2>
                    <div class="settings-group">
                        <label>Haftalƒ±k Gereken Saat</label>
                        <input type="number" id="weeklyLimit" value="45" onchange="recalculateAll()">
                    </div>
                    <div class="settings-group">
                        <label>Ba≈ülangƒ±√ß Ayƒ± (ƒ∞≈üe Ba≈üladƒ±ƒüƒ±nƒ±z Ay)</label>
                        <select id="startMonth" onchange="onStartMonthChange()">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="settings-group">
                        <label>Ba≈ülangƒ±√ß G√ºn√º (Ayƒ±n Hangi G√ºn√º ƒ∞≈üe Ba≈üladƒ±nƒ±z)</label>
                        <select id="startDay" onchange="onStartDayChange()">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="settings-group">
                        <label>Varsayƒ±lan Giri≈ü/√áƒ±kƒ±≈ü</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="time" id="defStart" value="09:00">
                            <input type="time" id="defEnd" value="18:00">
                        </div>
                    </div>
                    <div class="settings-group">
                        <label>Varsayƒ±lan Mola (Dk)</label>
                        <input type="number" id="defBreak" value="60">
                    </div>
                    <button onclick="saveData()" class="secondary">üíæ Kaydet</button>
                    <button onclick="resetData()" style="background-color: var(--danger); margin-top: 0.5rem;">üóëÔ∏è
                        Sƒ±fƒ±rla</button>
                </div>

                <div class="card">
                    <h2>Yƒ±llƒ±k √ñzet</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Ay</th>
                                <th>Fark</th>
                                <th>K√ºm√ºlatif</th>
                            </tr>
                        </thead>
                        <tbody id="summaryBody">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                    <div style="margin-top: 1rem; font-weight: bold; text-align: right;">
                        Yƒ±l Sonu Toplam: <span id="yearTotal">0</span> saat
                    </div>
                </div>
            </div>

            <!-- Right Column: Month Editor -->
            <div>
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 id="monthTitle">Ocak Detayƒ±</h2>
                        <button onclick="fillMonthDefaults()" id="fillBtn" class="secondary"
                            style="width: auto; padding: 0.5rem 1rem;">
                            ‚ö° Otomatik Doldur
                        </button>
                    </div>

                    <div id="lockedBannerContainer"></div>

                    <div style="max-height: 600px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>G√ºn</th>
                                    <th>Giri≈ü</th>
                                    <th>√áƒ±kƒ±≈ü</th>
                                    <th>Mola</th>
                                    <th>S√ºre</th>
                                </tr>
                            </thead>
                            <tbody id="daysBody">
                                <!-- JS will populate -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const months = [
            "Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran",
            "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"
        ];

        // Data Structure: yearData[monthIndex][dayIndex] = { start, end, break }
        let yearData = {};
        let currentMonth = 0;
        const currentYear = new Date().getFullYear();

        // startMonth: earliest editable month index (0 = Ocak). Default 0.
        let startMonth = 0;
        // startDay: day in the startMonth (1..31). Default 1.
        let startDay = 1;

        function init() {
            loadData();
            populateStartMonthSelect();
            populateStartDaySelect();
            renderSummary();
            renderMonth(currentMonth);
        }

        function populateStartMonthSelect() {
            const sel = document.getElementById('startMonth');
            sel.innerHTML = '';
            months.forEach((m, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.innerText = m;
                sel.appendChild(opt);
            });
            sel.value = startMonth;
        }

        function populateStartDaySelect() {
            const sel = document.getElementById('startDay');
            sel.innerHTML = '';
            // days in currently selected startMonth
            const daysInMonth = getDaysInMonth(startMonth, currentYear);
            for (let d = 1; d <= daysInMonth; d++) {
                const opt = document.createElement('option');
                opt.value = d;
                opt.innerText = d;
                sel.appendChild(opt);
            }
            // if saved startDay > daysInMonth clamp it
            if (startDay > daysInMonth) startDay = daysInMonth;
            sel.value = startDay;
        }

        function onStartMonthChange() {
            const sel = document.getElementById('startMonth');
            startMonth = parseInt(sel.value, 10);
            // update day select to match the selected month's day count
            populateStartDaySelect();
            saveData();
            // If current viewed month is before startMonth, switch view to startMonth
            if (currentMonth < startMonth) {
                renderMonth(startMonth);
            } else {
                renderMonth(currentMonth);
            }
            renderSummary();
        }

        function onStartDayChange() {
            const sel = document.getElementById('startDay');
            startDay = parseInt(sel.value, 10);
            saveData();
            // if viewing startMonth and current day view is before startDay, keep editing disabled for those days
            renderMonth(currentMonth);
            renderSummary();
        }

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getDayName(day, month, year) {
            const date = new Date(year, month, day);
            return date.toLocaleDateString('tr-TR', { weekday: 'long' });
        }

        function isSunday(day, month, year) {
            return new Date(year, month, day).getDay() === 0;
        }

        function loadData() {
            const saved = localStorage.getItem('calismaSaatiData_v1');
            if (saved) {
                yearData = JSON.parse(saved);
            } else {
                // Initialize empty structure
                for (let m = 0; m < 12; m++) {
                    yearData[m] = {};
                }
            }

            const savedLimit = localStorage.getItem('weeklyLimit');
            if (savedLimit) document.getElementById('weeklyLimit').value = savedLimit;

            const savedStart = localStorage.getItem('startMonth');
            if (savedStart !== null) startMonth = parseInt(savedStart, 10);

            const savedStartDay = localStorage.getItem('startDay');
            if (savedStartDay !== null) startDay = parseInt(savedStartDay, 10);

            // Ensure yearData has keys for all months
            for (let m = 0; m < 12; m++) {
                if (!yearData[m]) yearData[m] = {};
            }
        }

        function saveData() {
            localStorage.setItem('calismaSaatiData_v1', JSON.stringify(yearData));
            localStorage.setItem('weeklyLimit', document.getElementById('weeklyLimit').value);
            localStorage.setItem('startMonth', String(startMonth));
            localStorage.setItem('startDay', String(startDay));
        }

        function resetData() {
            if (confirm('T√ºm veriler silinecek. Emin misiniz?')) {
                localStorage.removeItem('calismaSaatiData_v1');
                localStorage.removeItem('startMonth');
                localStorage.removeItem('startDay');
                location.reload();
            }
        }

        function calculateDuration(start, end, breakMin) {
            if (!start || !end) return 0;
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            let startMin = startH * 60 + startM;
            let endMin = endH * 60 + endM;
            if (endMin < startMin) endMin += 24 * 60; // Overnight
            const br = Number(breakMin) || 0;
            let workMin = endMin - startMin - br;
            return Math.max(0, workMin / 60);
        }

        function updateDay(monthIndex, dayIndex, field, value) {
            // prevent editing if month is locked or day is before the start day in the start month
            if (monthIndex < startMonth) return;
            if (monthIndex === startMonth && dayIndex < startDay) return;

            if (!yearData[monthIndex][dayIndex]) yearData[monthIndex][dayIndex] = {};
            yearData[monthIndex][dayIndex][field] = value;

            const start = yearData[monthIndex][dayIndex].start || "";
            const end = yearData[monthIndex][dayIndex].end || "";
            const brk = Number(yearData[monthIndex][dayIndex].break) || 0;

            const duration = calculateDuration(start, end, brk);
            const durEl = document.getElementById(`dur-${monthIndex}-${dayIndex}`);
            if (durEl) durEl.innerText = duration.toFixed(2);

            saveData();
            renderSummary(); // Update summary in real-time
        }

        function fillMonthDefaults() {
            // Only allow fill if this month is editable (not before startMonth)
            if (currentMonth < startMonth) {
                alert(`${months[currentMonth]} ayƒ± d√ºzenleme kilitli. Ba≈ülangƒ±√ß tarihi: ${months[startMonth]} ${startDay}.`);
                return;
            }

            const start = document.getElementById('defStart').value;
            const end = document.getElementById('defEnd').value;
            const brk = document.getElementById('defBreak').value;
            const daysCount = getDaysInMonth(currentMonth, currentYear);

            for (let d = 1; d <= daysCount; d++) {
                if (isSunday(d, currentMonth, currentYear)) continue; // Skip Sundays
                // If currentMonth is startMonth, do not fill days before startDay
                if (currentMonth === startMonth && d < startDay) continue;

                // Overwrite for "Fill" action for the selected month only.
                yearData[currentMonth][d] = { start, end, break: String(brk) };
            }
            renderMonth(currentMonth);
            renderSummary();
            saveData();
        }

        function renderMonth(monthIndex) {
            currentMonth = monthIndex;
            document.getElementById('monthTitle').innerText = `${months[monthIndex]} Detayƒ±`;

            // Highlight active month in summary
            document.querySelectorAll('.summary-row').forEach((el, idx) => {
                if (idx === monthIndex) el.classList.add('active');
                else el.classList.remove('active');
            });

            const tbody = document.getElementById('daysBody');
            tbody.innerHTML = '';
            const daysCount = getDaysInMonth(monthIndex, currentYear);

            // Clear banner container
            const bannerContainer = document.getElementById('lockedBannerContainer');
            bannerContainer.innerHTML = '';

            const monthLocked = monthIndex < startMonth;
            if (monthLocked) {
                // Show banner telling the user why it's locked
                const banner = document.createElement('div');
                banner.className = 'month-locked-banner';
                banner.innerText = `${months[monthIndex]} ayƒ± d√ºzenleme kilitli. Ba≈ülangƒ±√ß tarihi: ${months[startMonth]} ${startDay}.`;
                bannerContainer.appendChild(banner);
                document.getElementById('fillBtn').disabled = true;
            } else {
                document.getElementById('fillBtn').disabled = false;
            }

            for (let d = 1; d <= daysCount; d++) {
                const isSun = isSunday(d, monthIndex, currentYear);
                const dayName = getDayName(d, monthIndex, currentYear);
                const data = yearData[monthIndex][d] || {};

                const tr = document.createElement('tr');
                if (isSun) tr.classList.add('weekend');
                tr.id = `row-${monthIndex}-${d}`;

                // If month locked or this specific day is before startDay in startMonth, add 'locked' class
                const dayLocked = (monthIndex < startMonth) || (monthIndex === startMonth && d < startDay);
                if (dayLocked) tr.classList.add('locked');

                // Build cells with disabled attribute if locked
                const startVal = data.start || '';
                const endVal = data.end || '';
                const breakVal = data.break || (isSun ? 0 : 60);

                tr.innerHTML = `
                    <td><strong>${d}</strong> <span style="font-size:0.8em; color:#666">${dayName}</span></td>
                    <td><input type="time" value="${startVal}" ${dayLocked ? 'disabled' : ''} onchange="updateDay(${monthIndex}, ${d}, 'start', this.value)"></td>
                    <td><input type="time" value="${endVal}" ${dayLocked ? 'disabled' : ''} onchange="updateDay(${monthIndex}, ${d}, 'end', this.value)"></td>
                    <td><input type="number" value="${breakVal}" style="width:60px" ${dayLocked ? 'disabled' : ''} onchange="updateDay(${monthIndex}, ${d}, 'break', this.value)"></td>
                    <td id="dur-${monthIndex}-${d}" style="font-weight:bold">${calculateDuration(data.start, data.end, data.break || 0).toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function renderSummary() {
            const weeklyLimit = parseFloat(document.getElementById('weeklyLimit').value) || 45;
            const tbody = document.getElementById('summaryBody');
            tbody.innerHTML = '';

            let cumulative = 0;

            months.forEach((monthName, idx) => {
                // Calculate total worked hours in this month
                let monthWorked = 0;
                const daysCount = getDaysInMonth(idx, currentYear);

                let sundays = 0;
                for (let d = 1; d <= daysCount; d++) {
                    if (isSunday(d, idx, currentYear)) sundays++;
                    const data = yearData[idx][d] || {};
                    monthWorked += calculateDuration(data.start, data.end, data.break || 0);
                }

                const workDays = daysCount - sundays;
                const dailyAvg = weeklyLimit / 6;
                const monthRequired = workDays * dailyAvg;

                const diff = monthWorked - monthRequired;
                cumulative += diff;

                const tr = document.createElement('tr');
                tr.className = 'summary-row';
                const locked = idx < startMonth;
                if (locked) tr.classList.add('locked');

                // clicking locked months just opens month but editing is disabled; no fill allowed
                tr.onclick = () => {
                    renderMonth(idx);
                };

                const diffClass = diff > 0 ? 'positive' : (diff < -0.1 ? 'negative' : 'neutral');
                const cumClass = cumulative > 0 ? 'positive' : (cumulative < -0.1 ? 'negative' : 'neutral');

                tr.innerHTML = `
                    <td>${locked ? 'üîí ' : ''}${monthName}</td>
                    <td class="${diffClass}">${diff > 0 ? '+' : ''}${diff.toFixed(1)}</td>
                    <td class="${cumClass}">${cumulative > 0 ? '+' : ''}${cumulative.toFixed(1)}</td>
                `;
                tbody.appendChild(tr);
            });

            const totalEl = document.getElementById('yearTotal');
            totalEl.innerText = (cumulative > 0 ? '+' : '') + cumulative.toFixed(1);
            totalEl.className = cumulative > 0 ? 'positive' : (cumulative < 0 ? 'negative' : '');
        }

        function recalculateAll() {
            renderSummary();
            saveData();
        }

        init();
    </script>
</body>

</html>
